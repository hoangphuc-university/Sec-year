-- 1 2
CREATE OR REPLACE PROCEDURE KIEMTRA_VIPHAM(p_MONTH IN NUMBER, p_YEAR IN NUMBER)
IS
BEGIN
    DECLARE
        CURSOR CUR_VIPHAM IS SELECT LOI.NOIDUNG, DOITUONG.HOTEN FROM VIPHAM, DOITUONG, LOI WHERE LOI.MALOI = VIPHAM.MALOI AND DOITUONG.MADT = VIPHAM.MADT
            AND EXTRACT(MONTH FROM VIPHAM.THOIDIEMVP) = p_MONTH AND EXTRACT (YEAR FROM VIPHAM.THOIDIEMVP) = p_YEAR;
        TYPE REC_VIPHAM IS RECORD(
            NOIDUNGVP VARCHAR2(50),
            HOTEN VARCHAR2(50)
        );
        TYPE TABLE_VIPHAM IS TABLE OF REC_VIPHAM;
        LICHSUVP TABLE_VIPHAM;
    BEGIN
        OPEN CUR_VIPHAM;
        FETCH CUR_VIPHAM BULK COLLECT INTO LICHSUVP;
        IF LICHSUVP.COUNT = 0 OR p_MONTH < 1 OR p_MONTH > 12
        THEN
            BEGIN
                DBMS_OUTPUT.PUT_LINE('KHONG TIM THAY VI PHAM HOAC SAI NGAY THANG NAM');
            END;
        ELSE
            BEGIN
                FOR I IN 1..LICHSUVP.COUNT LOOP
                    DBMS_OUTPUT.PUT_LINE(I || ': TEN LOI VI PHAM: ' || LICHSUVP(i).NOIDUNGVP || ', TEN NGUOI VI PHAM: ' || LICHSUVP(i).HOTEN);
                END LOOP;
            END;
        END IF;
        CLOSE CUR_VIPHAM;
    END;
END;
/
-- 3
CREATE OR REPLACE PROCEDURE TONGSOLOIVP(P_THANG IN NUMBER, P_NAM IN NUMBER, P_MADT IN NVARCHAR2, TONGSOLOI OUT NUMBER)
IS
BEGIN
    DECLARE 
        CURSOR CUR_VIPHAM IS SELECT COUNT(*) AS SOLUONGLOI 
                            FROM VIPHAM 
                            WHERE EXTRACT (MONTH FROM THOIDIEMVP) = P_THANG 
                                    AND EXTRACT (YEAR FROM THOIDIEMVP) = P_NAM 
                                    AND MADT = P_MADT
                            GROUP BY MADT;
        SOLUONGLOI NUMBER;
    BEGIN
        SOLUONGLOI := 0;
        OPEN CUR_VIPHAM;
        FETCH CUR_VIPHAM INTO SOLUONGLOI;
        DBMS_OUTPUT.PUT_LINE('TỔNG SỐ LỖI VI PHẠM CỦA ĐỐI TƯỢNG ' || P_MADT || ' LÀ: ' || SOLUONGLOI);
        CLOSE CUR_VIPHAM;
    END;
END;
/
-- 4
CREATE OR REPLACE FUNCTION FUNC_TONGSOLOIVP(P_THANG IN NUMBER, P_NAM IN NUMBER, P_MADT IN VARCHAR2)
RETURN NUMBER
IS
CURSOR CUR_VIPHAM IS SELECT COUNT(*) FROM VIPHAM
                    WHERE MADT = P_MADT AND EXTRACT(MONTH FROM THOIDIEMVP) = P_THANG AND EXTRACT(YEAR FROM THOIDIEMVP) = P_NAM
                    GROUP BY MADT;
SOLUONGVP NUMBER;
BEGIN
    OPEN CUR_VIPHAM;
    FETCH CUR_VIPHAM INTO SOLUONGVP;
    CLOSE CUR_VIPHAM;
    RETURN SOLUONGVP;
END FUNC_TONGSOLOIVP;
/
-- 5
CREATE OR REPLACE PROCEDURE PROC_SONGLOINHAT(P_NAM IN NUMBER, SONGLOINHAT OUT CURSOR)
IS
CURSOR CUR_SONGLOINHAT IS SELECT DOITUONG.HOTEN, COUNT(*) AS TONGSOLOI
                        FROM DOITUONG INNER JOIN VIPHAM ON DOITUONG.MADT = VIPHAM.MADT
                        GROUP BY VIPHAM.MADT
                        HAVING COUNT(*) = (SELECT MAX (SOLUONGLOI)
                                                FROM (SELECT COUNT(*) AS SOLUONGLOI
                                                        FROM VIPHAM
                                                        GROUP BY VIPHAM.MADT));

BEGIN
    SONGLOINHAT:=CUR_SONGLOINHAT;
END;